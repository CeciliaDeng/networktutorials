---
title: "Network analysis - _manta_ and _anuran_ "
author: "Lisa Rottjers"
date: "9 november 2018"
output: html_document
fig_width: 8
fig_height: 4
---

# Network analysis - node importance
  
In this tutorial, you will carry out an analysis of two different networks with [_manta_](https://github.com/ramellose/manta) and [_anuran_](https://github.com/ramellose/anuran). If you have not yet installed these tools, please follow the instructions on their homepages. Both software tools have a command line interface. This means that you do not need to know Python: all commands can be run on a [Unix shell](https://en.wikipedia.org/wiki/Unix_shell) or [Windows Command Prompt](https://en.wikipedia.org/wiki/Cmd.exe). 

## Step 1 - Data

If you have worked through previous tutorials, you may be familiar with the arctic soils network. You can find the paper with the data [here](https://sfamjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.1462-2920.2010.02277.x). In this analysis, we will compare a [FlashWeave](https://www.sciencedirect.com/science/article/pii/S2405471219302716) network with the [SPIEC-EASI](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1004226) network. 
You can find both files in the repository. Download them from these links: [SPIEC-EASI](https://raw.githubusercontent.com/ramellose/networktutorials/master/Workshop%20network%20analysis%202020/arctic_spiec.graphml) and [FlashWeave](https://raw.githubusercontent.com/ramellose/networktutorials/master/Workshop%20network%20analysis%202020/arctic_flash.graphml) by right-clicking the page, selecting 'Save page as...' and saving them as .graphml files. 

The networks are shown below: the SpiecEasi network on the left, and the FlashWeave network on the right. 
```{r flash1, fig.margin=TRUE, out.width='30%', echo=FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/ramellose/networktutorials/master/Workshop%20network%20analysis%202020/spiec_base.PNG")
knitr::include_graphics("https://raw.githubusercontent.com/ramellose/networktutorials/master/Workshop%20network%20analysis%202020/flash_base.PNG")
```

## Step 2 - Checking your installation 

Now that you have downloaded the networks, you can run _manta_ on it. 
Open your terminal and check if your _manta_ installation works by running the help command. If you have correctly installed _manta_, you should get an explanation of all the parameters. 

```{r help1, message=FALSE, eval=FALSE}
manta -h
```
  
## Step 3 - Running _manta_ on the SPIEC-EASI and FlashWeave networks

There are two ways to import networks with _manta_: either you specify the complete file path, or you navigate to the directory where you saved the graphml files. Try navigating to the directory, since it will save you a lot of typing! Unfamiliar with command line? Check the [solutions](https://ramellose.github.io/networktutorials/workshop_demo_answers.html#cmd). 

Now that you are in the right location, run _manta_. Only the -i and -o parameters are mandatory; other parameters implement different features or set parameters of the clustering algorithm itself. With the --layout flag, the software will generate a layout as well, so the graph will be organized by cluster if it is imported into Cytoscape. 

```{r manta, message=FALSE, eval=FALSE}
manta -i arctic_spiec.graphml -o spiec_clustered.cyjs --layout 
```

How would you generate cluster robustness scores? And what is the difference between cluster assigments done on the network with edges set to -1 and 1, compared to the edge weights generated by SPIEC-EASI? Which nodes tend to have low robustness? [Solution.](https://ramellose.github.io/networktutorials/workshop_demo_answers.html#manta) 

Since the network is in a similar format, we can use the same command as with the SPIEC-EASI network. Can _manta_ cluster this network without edge weight conversion? 

## Step 4 - Running _anuran_ on the SPIEC-EASI and FlashWeave networks

Although both networks qualitatively look rather similar (and have similar clusters), it would be nice to have some idea of just how similar they are. For example, are the most central nodes in these networks identical? We can check such network properties with _anuran_. 

Like before, first check your installation. 

```{r help2, message=FALSE, eval=FALSE}
anuran -h
```

While _manta_ runs on one network at a time, _anuran_ accepts (multiple) groups of networks. It will try to import all networks in a folder and run analyses on these. Therefore, move your FlashWeave and SPIEC-EASI networks to a folder and give _anuran_ the name of the folder. We can get some initial figures with the -draw flag. Do you think that the networks are very similar? How big is the overlap?  [Solution.](https://ramellose.github.io/networktutorials/workshop_demo_answers.html#anuran) 

```{r anuran, message=FALSE, eval=FALSE}
anuran -i folder -o demo -draw
```

With the default plotting, the y-axis is a bit inconvenient because the difference is so much larger than the intersection. We can import the csv file and plot the intersection with ggplot2. 

```{r anuranplot, message=FALSE}
library(ggplot2)

data <- read.csv('demo_sets.csv')
data <- data[data$Set.type == 'Intersection 1',]
data$Network <- factor(data$Network, c('Input', 'Degree', 'Random'))
ggplot(data, aes(x=Network, y=Set.size, colour=Network)) + geom_point() + theme_minimal()
```

The intersection sizes that are generated, are a function of the matching edges across networks. Networks can be similar even if the edges are not. For example, nodes that occupy a central position in one network may also be central in the second network, even if they share no neighbours. We only need to add a single flag to study node centralities with _anuran_. We will also reduce the number of null models and iterations, so it runs a bit faster. 

```{r centrality, message=FALSE, eval=FALSE}
anuran -i folder -o demo -draw -c -perm 5 -nperm 10
```

With R, we can import the csv file that was just generated. 

```{r centralities, message=FALSE}
centralities <- read.csv('demo_centralities.csv', stringsAsFactors = FALSE)
knitr::kable(head(centralities, 3))
```

The table above shows the first three values of the csv file. In this case, it shows for three taxa the 95% confidence interval of the degree (Upper.limit and Lower.limit). However, we only have two measurements: one centrality value per network. Let's extract the degree rankings from the right column and plot these against each other. We can do this with a little string parsing. A function that will parse the values is given below; can you loop over the dataframe and generate columns with centralities for FlashWeave and SPIEC-EASI? Keep in mind that taxa may be in one network, but not the other! [Solution.](https://ramellose.github.io/networktutorials/workshop_demo_answers.html#central) 

```{r parse, message=FALSE, warning=FALSE}
library(stringr)
value <- centralities$Values[[1]]
parts <- strsplit(value, ', ')
flash <- as.numeric(str_sub(parts[[1]][2], end=-2))
spiec <- as.numeric(str_sub(parts[[1]][4], end=-3))
```

```{r parse2, message=FALSE, echo=FALSE, warning=FALSE}
library(stringr)
flash <- c()
spiec <- c()
for (i in 1:nrow(centralities)){
  value <- centralities$Values[[i]]
  value <- strsplit(value, ')')
  if (length(value[[1]]) == 2){
    if (grepl('flash', value[[1]][1])){
        parts <- strsplit(value[[1]][1], ', ')
        flash <- c(flash, as.numeric(parts[[1]][2]))
        spiec <- c(spiec, 'NA')
    } else if (grepl('spiec', value[[1]][1])){
        parts <- strsplit(value[[1]][1], ', ')
        flash <- c(flash, 'NA')
        spiec <- c(spiec, as.numeric(parts[[1]][2]))
    }}
  else {
    parts <- strsplit(value[[1]][1], ', ')
    flash <- c(flash, as.numeric(parts[[1]][2]))
    parts <- strsplit(value[[1]][2], ', ')
    spiec <- c(spiec, as.numeric(parts[[1]][3]))
  }
}
centralities$FlashWeave <- as.numeric(flash)
centralities$SpiecEasi <- as.numeric(spiec)
```

With the centralities extracted, we can test several things:
1. Is there a strong correlation between high rankings in the FlashWeave and SPIEC-EASI networks? 
2. Is this correlation similar for the null models? 

Please find the figure for the degree centrality below. Try generating it for the other centralities yourself.  [Solution.](https://ramellose.github.io/networktutorials/workshop_demo_answers.html#plot)

```{r fig, message=FALSE, warning=FALSE}
library(ggplot2)
networks <- centralities[centralities$Network == 'Input',]
networks <- networks[networks$Centrality == 'Degree',]
ggplot(data=networks, aes(x=FlashWeave, y=SpiecEasi)) + geom_point(alpha=0.05) + geom_smooth() + theme_minimal()

```

Not only is the overlap between assocations much larger, the centralities are rather well correlated. A node that is central in the FlashWeave network tends to be central in the SpiecEasi network. However, we do see that nodes at the 'intermediate' end have a lot of variablity, and not all nodes that are central in the Flashweave network are very central in the SpiecEasi. 

One reason for this variability could be that the edges are conserved at higher taxonomic levels: sometimes, one taxon from a specific genus may have a significant association, but in a different network, another taxon from the same genus may get that association. We can look into this by agglomerating abundances by taxonomy. 

You don't need to run FlashWeave and SpiecEasi yourself. Download the networks from the repository and run anuran on them. 


```{r centrality_corr, message=FALSE, eval=FALSE}
anuran -i folder -o demo_genus -draw -c -perm 5 -nperm 10
```

With the genus-level networks, we can now run _anuran_ again and compare the intersection to the previous intersection. 
Do you think the variability of the degree is lower? Is the intersection, as a fraction of the network size, larger or smaller? [Solution.](https://ramellose.github.io/networktutorials/workshop_demo_answers.html#genus)
